{% extends 'index_template.html' %}
{% load static %}

{% block content %}

    <div class="container py-4">
        <div class="row">
            <div class="col-lg-12 mx-auto">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h2 class="mb-0" style="font-size: 1.5rem">üìä –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ê–Ω–∞–ª–æ–≥–æ-–¶–∏—Ñ—Ä–æ–≤–æ–≥–æ –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                    </div>
                    <div class="card-body">
                        <form method="post" id="adcForm">
                            {% csrf_token %}

                            <!-- –í—ã–≤–æ–¥ –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º—ã -->
                            {% if form.errors %}
                            <div class="alert alert-danger">
                                <strong>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏:</strong>
                                <ul>
                                    {% for field in form %}
                                        {% for error in field.errors %}
                                            <li>{{ field.label }}: {{ error }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}

                            <div class="row">
                                <div class="col-md-6">
                                    <h4>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ê–¶–ü</h4>
                                    <div class="mb-3">
                                        {{ form.resolution.label_tag }}
                                        {{ form.resolution }}
                                        <div class="form-text">
                                            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏—Ç (8, 10, 12, 14, 16, 24)
                                        </div>
                                        {% if form.resolution.errors %}
                                        <div class="text-danger">{{ form.resolution.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="mb-3">
                                        {{ form.vref.label_tag }}
                                        {{ form.vref }}
                                        <div class="form-text">
                                            –û–±—ã—á–Ω–æ: 3.3–í, 5–í, 10–í
                                        </div>
                                        {% if form.vref.errors %}
                                        <div class="text-danger">{{ form.vref.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="mb-3">
                                        {{ form.vmin.label_tag }}
                                        {{ form.vmin }}
                                        {% if form.vmin.errors %}
                                        <div class="text-danger">{{ form.vmin.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <h4>–í—Ö–æ–¥–Ω–æ–π —Å–∏–≥–Ω–∞–ª</h4>
                                    <div class="mb-3">
                                        {{ form.analog_voltage.label_tag }}
                                        {{ form.analog_voltage }}
                                        <div class="form-text">
                                            –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ –Ω–∞ –≤—Ö–æ–¥–µ –ê–¶–ü
                                        </div>
                                        {% if form.analog_voltage.errors %}
                                        <div class="text-danger">{{ form.analog_voltage.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <h5 class="mt-4">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h5>
                                    <div class="mb-3">
                                        {{ form.sampling_rate.label_tag }}
                                        {{ form.sampling_rate }}
                                        {% if form.sampling_rate.errors %}
                                        <div class="text-danger">{{ form.sampling_rate.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="mb-3">
                                        {{ form.signal_frequency.label_tag }}
                                        {{ form.signal_frequency }}
                                        {% if form.signal_frequency.errors %}
                                        <div class="text-danger">{{ form.signal_frequency.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary btn-lg flex-grow-1">
                                    üßÆ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ê–¶–ü
                                </button>
                                <a href="{% url 'adc_calculator' %}" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-counterclockwise"></i>üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
            </a>
<!--                                <button type="reset" class="btn btn-outline-secondary btn-lg">-->
<!--                                    üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É-->
<!--                                </button>-->
                            </div>
                        </form>
                    </div>
                </div>

                {% if result and characteristics %}
                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞ -->
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h3 class="mb-0">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è</h3>
                    </div>
                    <div class="card-body">
                        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è -->
                        {% if characteristics and characteristics.voltage_range %}
                        <div class="mb-4">
                            <h5>–ü–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ:</h5>
                            <div class="voltage-indicator">
                                <div class="voltage-marker"
                                     style="left: {{ characteristics.voltage_range|default:0|floatformat:2 }}%">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>{{ form.vmin.value|default:"0" }} –í</span>
                                <span><strong>{{ form.analog_voltage.value|default:"0" }} –í</strong></span>
                                <span>{{ form.vref.value|default:"5" }} –í</span>
                            </div>
                        </div>
                        {% endif %}

                        {% if result.digital_binary %}
                        <!-- –¶–∏—Ñ—Ä–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ -->
                        <div class="digital-display">
                            {{ result.digital_binary }}
                        </div>
                        {% endif %}

                        <div class="row">
                            <div class="col-md-6">
                                <div class="result-box">
                                    <h5>–¶–∏—Ñ—Ä–æ–≤—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è:</h5>
                                    {% if result.digital_decimal %}
                                    <div class="characteristic-item">
                                        <span>–î–µ—Å—è—Ç–∏—á–Ω–æ–µ:</span>
                                        <strong>{{ result.digital_decimal }}</strong>
                                    </div>
                                    {% endif %}

                                    {% if result.digital_binary %}
                                    <div class="characteristic-item">
                                        <span>–î–≤–æ–∏—á–Ω–æ–µ:</span>
                                        <strong>{{ result.digital_binary }}</strong>
                                    </div>
                                    {% endif %}

                                    {% if result.digital_hex %}
                                    <div class="characteristic-item">
                                        <span>–®–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç–µ—Ä–∏—á–Ω–æ–µ:</span>
                                        <strong>{{ result.digital_hex }}</strong>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="result-box">
                                    <h5>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è:</h5>
                                    {% if form.analog_voltage.value %}
                                    <div class="characteristic-item">
                                        <span>–ò—Å—Ö–æ–¥–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ:</span>
                                        <strong>{{ form.analog_voltage.value|floatformat:3 }} –í</strong>
                                    </div>
                                    {% endif %}

                                    {% if result.actual_voltage %}
                                    <div class="characteristic-item">
                                        <span>–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ:</span>
                                        <strong>{{ result.actual_voltage|floatformat:4 }} –í</strong>
                                    </div>
                                    {% endif %}

                                    {% if result.quantization_error %}
                                    <div class="characteristic-item">
                                        <span>–û—à–∏–±–∫–∞ –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏—è:</span>
                                        <strong>{{ result.quantization_error|floatformat:6 }} –í</strong>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –ê–¶–ü -->
                {% if characteristics %}
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –ê–¶–ü</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                {% if form.resolution.value %}
                                <div class="characteristic-item">
                                    <span>–†–∞–∑—Ä—è–¥–Ω–æ—Å—Ç—å:</span>
                                    <strong>{{ form.resolution.value }} –±–∏—Ç</strong>
                                </div>
                                {% endif %}

                                {% if characteristics.quantization_step %}
                                <div class="characteristic-item">
                                    <span>–®–∞–≥ –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏—è (LSB):</span>
                                    <strong>{{ characteristics.quantization_step|floatformat:6 }} –í</strong>
                                </div>
                                {% endif %}

                                {% if characteristics.quantization_step_mv %}
                                <div class="characteristic-item">
                                    <span>–®–∞–≥ –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏—è:</span>
                                    <strong>{{ characteristics.quantization_step_mv|floatformat:3 }} –º–í</strong>
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                {% if characteristics.dynamic_range_db %}
                                <div class="characteristic-item">
                                    <span>–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω:</span>
                                    <strong>{{ characteristics.dynamic_range_db|floatformat:2 }} –¥–ë</strong>
                                </div>
                                {% endif %}

                                {% if characteristics.max_digital_value %}
                                <div class="characteristic-item">
                                    <span>–ú–∞–∫—Å. —Ü–∏—Ñ—Ä–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</span>
                                    <strong>{{ characteristics.max_digital_value }}</strong>
                                </div>
                                {% endif %}

                                {% if characteristics.voltage_range %}
                                <div class="characteristic-item">
                                    <span>–î–∏–∞–ø–∞–∑–æ–Ω –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–π:</span>
                                    <strong>{{ characteristics.voltage_range|floatformat:3 }} –í</strong>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è -->
                {% if result.examples %}
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">–¢–∞–±–ª–∏—Ü–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ (–í)</th>
                                        <th>–¶–∏—Ñ—Ä–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</th>
                                        <th>–î–≤–æ–∏—á–Ω–æ–µ</th>
                                        <th>–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ (–í)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for example in result.examples %}
                                    <tr {% if example.voltage == form.analog_voltage.value %}class="table-success"{% endif %}>
                                        <td>{{ example.voltage|floatformat:3 }}</td>
                                        <td>{{ example.digital }}</td>
                                        <td><code>{{ example.binary }}</code></td>
                                        <td>{{ example.actual|floatformat:4 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- SNR –∏ —á–∞—Å—Ç–æ—Ç–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
                {% if snr_info %}
                <div class="card">
                    <div class="card-header bg-warning">
                        <h4 class="mb-0">–ß–∞—Å—Ç–æ—Ç–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏ SNR</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                {% if snr_info.snr_ideal %}
                                <div class="characteristic-item">
                                    <span>–ò–¥–µ–∞–ª—å–Ω—ã–π SNR:</span>
                                    <strong>{{ snr_info.snr_ideal|floatformat:2 }} –¥–ë</strong>
                                </div>
                                {% endif %}

                                {% if snr_info.enob %}
                                <div class="characteristic-item">
                                    <span>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –±–∏—Ç—ã (ENOB):</span>
                                    <strong>{{ snr_info.enob|floatformat:2 }} –±–∏—Ç</strong>
                                </div>
                                {% endif %}

                                {% if snr_info.nyquist_freq %}
                                <div class="characteristic-item">
                                    <span>–ß–∞—Å—Ç–æ—Ç–∞ –ù–∞–π–∫–≤–∏—Å—Ç–∞:</span>
                                    <strong>{{ snr_info.nyquist_freq|floatformat:0 }} –ì—Ü</strong>
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                {% if snr_info.sampling_period %}
                                <div class="characteristic-item">
                                    <span>–ü–µ—Ä–∏–æ–¥ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏:</span>
                                    <strong>{{ snr_info.sampling_period|floatformat:3 }} –º—Å</strong>
                                </div>
                                {% endif %}

                                {% if snr_info.max_signal_freq %}
                                <div class="characteristic-item">
                                    <span>–ú–∞–∫—Å. —á–∞—Å—Ç–æ—Ç–∞ —Å–∏–≥–Ω–∞–ª–∞:</span>
                                    <strong>{{ snr_info.max_signal_freq|floatformat:0 }} –ì—Ü</strong>
                                </div>
                                {% endif %}

                                {% if snr_info.is_aliasing is not None %}
                                <div class="characteristic-item">
                                    <span>–ù–∞–ª–∏—á–∏–µ –∞–ª–∏–∞—Å–∏–Ω–≥–∞:</span>
                                    <strong class="{% if snr_info.is_aliasing %}text-danger{% else %}text-success{% endif %}">
                                        {% if snr_info.is_aliasing %}–î–ê ‚ö†Ô∏è{% else %}–ù–ï–¢ ‚úÖ{% endif %}
                                    </strong>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% if snr_info.is_aliasing %}
                        <div class="alert alert-danger mt-3">
                            ‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –ß–∞—Å—Ç–æ—Ç–∞ —Å–∏–≥–Ω–∞–ª–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—É –ù–∞–π–∫–≤–∏—Å—Ç–∞.
                            –í–æ–∑–Ω–∏–∫–∞–µ—Ç –∞–ª–∏–∞—Å–∏–Ω–≥ (–Ω–∞–ª–æ–∂–µ–Ω–∏–µ —Å–ø–µ–∫—Ç—Ä–æ–≤). –£–≤–µ–ª–∏—á—å—Ç–µ —á–∞—Å—Ç–æ—Ç—É –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏.
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% endif %}

                <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                <div class="card mt-3">
                    <div class="card-body">
                        <h5>üìù –ü–æ—è—Å–Ω–µ–Ω–∏—è:</h5>
                        <ul>
                            <li><strong>–®–∞–≥ –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏—è (LSB)</strong> - –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç —Ä–∞–∑–ª–∏—á–∏—Ç—å –ê–¶–ü</li>
                            <li><strong>–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω</strong> - –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ –∫ —à—É–º—É (–≤ –¥–ë)</li>
                            <li><strong>SNR</strong> - –æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª/—à—É–º –¥–ª—è —Å–∏–Ω—É—Å–æ–∏–¥–∞–ª—å–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞</li>
                            <li><strong>–ß–∞—Å—Ç–æ—Ç–∞ –ù–∞–π–∫–≤–∏—Å—Ç–∞</strong> - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ —Å–∏–≥–Ω–∞–ª–∞ –ø—Ä–∏ –¥–∞–Ω–Ω–æ–π —á–∞—Å—Ç–æ—Ç–µ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏</li>
                            <li><strong>ENOB</strong> - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —á–∏—Å–ª–æ —Ä–∞–∑—Ä—è–¥–æ–≤ —Å —É—á–µ—Ç–æ–º —Ä–µ–∞–ª—å–Ω—ã—Ö —à—É–º–æ–≤</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è
        function updateVoltageIndicator() {
            const voltageInput = document.querySelector('#id_analog_voltage');
            const vminInput = document.querySelector('#id_vmin');
            const vrefInput = document.querySelector('#id_vref');

            if (voltageInput && vminInput && vrefInput) {
                const voltage = parseFloat(voltageInput.value) || 0;
                const vmin = parseFloat(vminInput.value) || 0;
                const vref = parseFloat(vrefInput.value) || 5;

                if (vref > vmin) {
                    const position = ((voltage - vmin) / (vref - vmin)) * 100;
                    const marker = document.querySelector('.voltage-marker');
                    if (marker) {
                        marker.style.left = Math.min(100, Math.max(0, position)) + '%';
                    }
                }
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏–π
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('#id_analog_voltage, #id_vmin, #id_vref');
            inputs.forEach(input => {
                input.addEventListener('input', updateVoltageIndicator);
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            updateVoltageIndicator();
        });
    </script>


   <style>
        .card {
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result-box {
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 15px;
        }
        .characteristic-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .voltage-indicator {
            height: 20px;
            background: linear-gradient(to right, #28a745, #ffc107, #dc3545);
            margin: 10px 0;
            border-radius: 10px;
            position: relative;
        }
        .voltage-marker {
            position: absolute;
            top: -5px;
            width: 2px;
            height: 30px;
            background-color: #000;
        }
        .digital-display {
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-size: 1.2em;
            text-align: center;
            margin: 10px 0;
        }
        .form-control:invalid {
            border-color: #dc3545;
        }
        .form-control:valid {
            border-color: #28a745;
        }
    </style>

{% endblock %}